{% extends "base.html" %}

{% block title %}Proveedores - Epicuro{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-0">
                    <i class="fas fa-truck me-3"></i>
                    Gestión de Proveedores
                </h1>
                <p class="mb-0 mt-2 opacity-75">Administra tus proveedores e información de contacto</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{{ url_for('new_supplier') if url_for else '#' }}" class="btn btn-light btn-lg" onclick="if(!this.href || this.href.endsWith('#')) { alert('Función en desarrollo'); return false; }">
                    <i class="fas fa-plus-circle me-2"></i>
                    Nuevo Proveedor
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filtros y Búsqueda -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text">
                <i class="fas fa-search"></i>
            </span>
            <input type="text" class="form-control" placeholder="Buscar proveedor..." id="searchSupplier">
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filterStatus">
            <option value="">Todos los estados</option>
            <option value="active">Activos</option>
            <option value="inactive">Inactivos</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filterType">
            <option value="">Todos los tipos</option>
            <option value="food">Alimentos</option>
            <option value="beverage">Bebidas</option>
            <option value="equipment">Equipos</option>
            <option value="service">Servicios</option>
        </select>
    </div>
</div>

<!-- Lista de Proveedores -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>
            Proveedores Registrados
        </h5>
        <span class="badge bg-primary">{{ suppliers|length if suppliers else 0 }} proveedores</span>
    </div>
    <div class="card-body p-0">
        {% if suppliers %}
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="suppliersTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Contacto</th>
                            <th>Tipo</th>
                            <th>Estado</th>
                            <th>Productos</th>
                            <th>Última Compra</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for supplier in suppliers %}
                        <tr class="supplier-row"
                            data-name="{{ supplier.name.lower() if supplier.name else (supplier[1].lower() if supplier|length > 1 else '') }}"
                            data-type="{{ supplier.type if supplier.type else (supplier[5] if supplier|length > 5 else 'general') }}"
                            data-status="{{ supplier.status if supplier.status else (supplier[6] if supplier|length > 6 else 'active') }}">
                            <td>
                                <div>
                                    <strong>{{ supplier.name if supplier.name else supplier[1] }}</strong>
                                    {% if supplier.company or (supplier|length > 2 and supplier[2]) %}
                                        <br><small class="text-muted">{{ supplier.company or supplier[2] }}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div>
                                    {% if supplier.phone or (supplier|length > 3 and supplier[3]) %}
                                        <div><i class="fas fa-phone me-1"></i>{{ supplier.phone or supplier[3] }}</div>
                                    {% endif %}
                                    {% if supplier.email or (supplier|length > 4 and supplier[4]) %}
                                        <div><i class="fas fa-envelope me-1"></i>{{ supplier.email or supplier[4] }}</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% set supplier_type = supplier.type if supplier.type else (supplier[5] if supplier|length > 5 else 'general') %}
                                {% set type_colors = {
                                    'food': 'success',
                                    'beverage': 'info', 
                                    'equipment': 'warning',
                                    'service': 'secondary'
                                } %}
                                <span class="badge bg-{{ type_colors.get(supplier_type, 'secondary') }}">
                                    {{ supplier_type|title if supplier_type else 'General' }}
                                </span>
                            </td>
                            <td>
                                {% set supplier_status = supplier.status if supplier.status else (supplier[6] if supplier|length > 6 else 'active') %}
                                {% if supplier_status == 'active' or supplier_status == 1 %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Activo
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-pause me-1"></i>Inactivo
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-primary">
                                    0 productos
                                </span>
                            </td>
                            <td>
                                <small class="text-muted">Nunca</small>
                            </td>
                            <td>
                                {% set supplier_id = supplier.id if supplier.id else supplier[0] %}
                                {% set supplier_name = supplier.name if supplier.name else supplier[1] %}
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary" 
                                            title="Ver detalles" 
                                            onclick="viewSupplier({{ supplier_id }}, '{{ supplier_name }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" 
                                            title="Editar" 
                                            onclick="editSupplier({{ supplier_id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" 
                                            title="Eliminar"
                                            onclick="deleteSupplier({{ supplier_id }}, '{{ supplier_name }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-truck fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No hay proveedores registrados</h4>
                <p class="text-muted">Comienza agregando tu primer proveedor</p>
                <a href="{{ url_for('new_supplier') if url_for else '#' }}" class="btn btn-primary" onclick="if(!this.href || this.href.endsWith('#')) { alert('Función en desarrollo'); return false; }">
                    <i class="fas fa-plus me-2"></i>Agregar Primer Proveedor
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Estadísticas Rápidas -->
{% if suppliers %}
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-truck fa-2x text-primary mb-2"></i>
                <h5>{{ suppliers|length }}</h5>
                <small class="text-muted">Total Proveedores</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h5 id="active-suppliers-count">{{ suppliers|length }}</h5>
                <small class="text-muted">Activos</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-box fa-2x text-warning mb-2"></i>
                <h5>0</h5>
                <small class="text-muted">Productos Total</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-calendar fa-2x text-info mb-2"></i>
                <h5>0</h5>
                <small class="text-muted">Con Compras</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal para ver detalles del proveedor -->
<div class="modal fade" id="viewSupplierModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-truck me-2"></i>Detalles del Proveedor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="supplier-details-content">
                    <!-- Contenido se llenará dinámicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="editSupplierFromModal()">
                    <i class="fas fa-edit me-2"></i>Editar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSupplierId = null;

// Búsqueda en tiempo real
document.getElementById('searchSupplier').addEventListener('input', function() {
    filterTable();
});

// Filtros
document.getElementById('filterStatus').addEventListener('change', function() {
    filterTable();
});

document.getElementById('filterType').addEventListener('change', function() {
    filterTable();
});

function filterTable() {
    const searchTerm = document.getElementById('searchSupplier').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const typeFilter = document.getElementById('filterType').value;
    
    const rows = document.querySelectorAll('.supplier-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.dataset.name || '';
        const type = row.dataset.type || '';
        const status = row.dataset.status || '';
        const contact = row.cells[1].textContent.toLowerCase();
        
        let showRow = true;
        
        // Filtro de búsqueda
        if (searchTerm && !name.includes(searchTerm) && !contact.includes(searchTerm)) {
            showRow = false;
        }
        
        // Filtro de estado
        if (statusFilter === 'active' && status !== 'active' && status !== '1') {
            showRow = false;
        } else if (statusFilter === 'inactive' && (status === 'active' || status === '1')) {
            showRow = false;
        }
        
        // Filtro de tipo
        if (typeFilter && type !== typeFilter) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    });
    
    // Actualizar contador
    document.querySelector('.badge.bg-primary').textContent = `${visibleCount} proveedores`;
}

// Función para ver detalles del proveedor
function viewSupplier(supplierId, supplierName) {
    currentSupplierId = supplierId;
    
    // Buscar la fila del proveedor para obtener más datos
    const rows = document.querySelectorAll('.supplier-row');
    let supplierRow = null;
    
    for (let row of rows) {
        if (row.style.display !== 'none') {
            const buttons = row.querySelectorAll('button[onclick*="' + supplierId + '"]');
            if (buttons.length > 0) {
                supplierRow = row;
                break;
            }
        }
    }
    
    if (supplierRow) {
        const name = supplierRow.cells[0].querySelector('strong').textContent;
        const company = supplierRow.cells[0].querySelector('small');
        const contactInfo = supplierRow.cells[1].innerHTML;
        const type = supplierRow.cells[2].textContent.trim();
        const status = supplierRow.cells[3].textContent.trim();
        
        const detailsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Información General</h6>
                    <p><strong>Nombre:</strong> ${name}</p>
                    ${company ? `<p><strong>Empresa:</strong> ${company.textContent}</p>` : ''}
                    <p><strong>Tipo:</strong> ${type}</p>
                    <p><strong>Estado:</strong> ${status}</p>
                </div>
                <div class="col-md-6">
                    <h6>Información de Contacto</h6>
                    <div>${contactInfo || '<p class="text-muted">Sin información de contacto</p>'}</div>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <h6>Estadísticas</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="h4 text-primary">0</div>
                                <small class="text-muted">Compras Totales</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="h4 text-success">$0</div>
                                <small class="text-muted">Monto Total</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="h4 text-info">Nunca</div>
                                <small class="text-muted">Última Compra</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('supplier-details-content').innerHTML = detailsHtml;
        const modal = new bootstrap.Modal(document.getElementById('viewSupplierModal'));
        modal.show();
    }
}

// Función para editar proveedor
function editSupplier(supplierId) {
    // Crear la URL dinámicamente en JavaScript
    const editUrl = `/inventory/suppliers/${supplierId}/edit`;
    
    // Verificar si la ruta existe haciendo una prueba
    fetch(editUrl, {method: 'HEAD'})
        .then(response => {
            if (response.ok) {
                window.location.href = editUrl;
            } else {
                alert(`Editar proveedor ID: ${supplierId}\n\nFunción en desarrollo`);
            }
        })
        .catch(() => {
            alert(`Editar proveedor ID: ${supplierId}\n\nFunción en desarrollo`);
        });
}

// Función para editar desde el modal
function editSupplierFromModal() {
    if (currentSupplierId) {
        editSupplier(currentSupplierId);
    }
}

// Función para eliminar proveedor
function deleteSupplier(supplierId, supplierName) {
    if (confirm(`¿Estás seguro de que quieres eliminar el proveedor "${supplierName}"?\n\nEsta acción no se puede deshacer.`)) {
        // Crear formulario para envío POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/inventory/suppliers/${supplierId}/delete`;
        form.style.display = 'none';
        document.body.appendChild(form);
        form.submit();
    }
}

// Atajos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl+F para buscar
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('searchSupplier').focus();
    }
    
    // Escape para cerrar modal
    if (e.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('viewSupplierModal'));
        if (modal) {
            modal.hide();
        }
    }
});

// Auto-focus en búsqueda
document.getElementById('searchSupplier').focus();
</script>
{% endblock %}