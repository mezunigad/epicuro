{% extends "base.html" %}

{% block title %}Reportes - Epicuro{% endblock %}

{% block extra_css %}
<style>
.metric-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 15px;
    padding: 20px;
    height: 100%;
    transition: transform 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-5px);
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.metric-label {
    opacity: 0.9;
    font-size: 0.9rem;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}

.top-product-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f1f3f4;
}

.top-product-item:last-child {
    border-bottom: none;
}

.product-rank {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
}

.product-rank.gold { background: #f39c12; }
.product-rank.silver { background: #95a5a6; }
.product-rank.bronze { background: #e67e22; }

.filter-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.export-btn {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.export-btn:hover {
    background: linear-gradient(135deg, #218838, #1fa084);
    color: white;
    transform: translateY(-2px);
}

.quick-filter {
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    color: #1976d2;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    text-decoration: none;
    transition: all 0.3s ease;
}

.quick-filter:hover {
    background: #1976d2;
    color: white;
    text-decoration: none;
}

.quick-filter.active {
    background: #1976d2;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-0">
                    <i class="fas fa-chart-bar me-3"></i>
                    Reportes y Analytics
                </h1>
                <p class="mb-0 mt-2 opacity-75">Análisis de ventas y rendimiento del negocio</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn export-btn" onclick="exportToExcel()">
                    <i class="fas fa-file-excel me-2"></i>
                    Exportar a Excel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filtros de fecha -->
<div class="filter-card">
    <form method="GET" action="{{ url_for('reports') }}" id="date-filter-form">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label for="start_date" class="form-label">
                    <i class="fas fa-calendar me-1"></i>Fecha Inicio
                </label>
                <input type="date" 
                       class="form-control" 
                       id="start_date" 
                       name="start_date" 
                       value="{{ request.args.get('start_date', '') }}">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label">
                    <i class="fas fa-calendar-check me-1"></i>Fecha Fin
                </label>
                <input type="date" 
                       class="form-control" 
                       id="end_date" 
                       name="end_date" 
                       value="{{ request.args.get('end_date', '') }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-2"></i>Filtrar
                </button>
            </div>
            <div class="col-md-3">
                <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-times me-2"></i>Limpiar
                </a>
            </div>
        </div>
        
        <!-- Filtros rápidos -->
        <div class="row mt-3">
            <div class="col-12">
                <label class="form-label mb-2">Filtros Rápidos:</label>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="javascript:void(0)" class="quick-filter" onclick="setDateRange('today')">Hoy</a>
                    <a href="javascript:void(0)" class="quick-filter" onclick="setDateRange('yesterday')">Ayer</a>
                    <a href="javascript:void(0)" class="quick-filter" onclick="setDateRange('week')">Esta Semana</a>
                    <a href="javascript:void(0)" class="quick-filter" onclick="setDateRange('last_week')">Semana Pasada</a>
                    <a href="javascript:void(0)" class="quick-filter" onclick="setDateRange('month')">Este Mes</a>
                    <a href="javascript:void(0)" class="quick-filter" onclick="setDateRange('last_month')">Mes Pasado</a>
                    <a href="javascript:void(0)" class="quick-filter" onclick="setDateRange('quarter')">Este Trimestre</a>
                    <a href="javascript:void(0)" class="quick-filter" onclick="setDateRange('year')">Este Año</a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Información del período seleccionado -->
{% if request.args.get('start_date') or request.args.get('end_date') %}
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Período seleccionado:</strong>
    {% if request.args.get('start_date') %}
        Desde {{ request.args.get('start_date') }}
    {% endif %}
    {% if request.args.get('end_date') %}
        hasta {{ request.args.get('end_date') }}
    {% endif %}
    {% if not request.args.get('start_date') and request.args.get('end_date') %}
        Hasta {{ request.args.get('end_date') }}
    {% endif %}
</div>
{% endif %}

<!-- Métricas principales - SOLO DATOS REALES -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="metric-value">${{ "{:,.0f}".format(stats.today_sales) }}</div>
                    <div class="metric-label">Ventas Hoy</div>
                </div>
                <div class="metric-icon">
                    <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="metric-value">${{ "{:,.0f}".format(stats.week_sales) }}</div>
                    <div class="metric-label">Ventas Esta Semana</div>
                </div>
                <div class="metric-icon">
                    <i class="fas fa-calendar-week fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="metric-value">${{ "{:,.0f}".format(stats.month_sales) }}</div>
                    <div class="metric-label">Ventas Este Mes</div>
                </div>
                <div class="metric-icon">
                    <i class="fas fa-calendar-alt fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="metric-value">{{ stats.total_orders }}</div>
                    <div class="metric-label">Órdenes (7 días)</div>
                </div>
                <div class="metric-icon">
                    <i class="fas fa-shopping-cart fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos y análisis -->
<div class="row">
    <!-- Top productos -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-trophy me-2"></i>
                    Top Productos (7 días)
                </h5>
            </div>
            <div class="card-body">
                {% if top_products %}
                    {% for product in top_products[:10] %}
                    <div class="top-product-item">
                        <div class="d-flex align-items-center">
                            <div class="product-rank {% if loop.index == 1 %}gold{% elif loop.index == 2 %}silver{% elif loop.index == 3 %}bronze{% endif %}">
                                {{ loop.index }}
                            </div>
                            <div class="ms-3">
                                <div class="fw-bold">{{ product.product_name }}</div>
                                <small class="text-muted">{{ product.total_quantity }} vendidos</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold text-success">${{ "{:,.0f}".format(product.total_revenue) }}</div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No hay ventas en los últimos 7 días</p>
                        <small class="text-muted">Los datos aparecerán cuando se registren ventas</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Ventas por categoría -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Ventas por Categoría
                </h5>
            </div>
            <div class="card-body">
                {% if category_sales %}
                    {% for category in category_sales %}
                        {% if category.total_sales > 0 %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <div class="me-2" style="width: 12px; height: 12px; background-color: {{ category.color }}; border-radius: 2px;"></div>
                                <span>{{ category.category_name }}</span>
                            </div>
                            <span class="text-success fw-bold">${{ "{:,.0f}".format(category.total_sales) }}</span>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No hay datos de categorías</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Horarios de venta -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Horarios de Venta (7 días)
                </h5>
            </div>
            <div class="card-body">
                {% if hourly_sales %}
                    {% for hour_data in hourly_sales %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ hour_data.hour }}:00</span>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 100px; height: 20px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ (hour_data.order_count / hourly_sales|map(attribute='order_count')|max * 100) if hourly_sales|map(attribute='order_count')|max > 0 else 0 }}%">
                                </div>
                            </div>
                            <span class="fw-bold">{{ hour_data.order_count }} órdenes</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No hay datos de horarios</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Métricas detalladas -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>
                    Resumen Detallado
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 text-center mb-3">
                        <h4 class="text-primary">${{ "{:,.0f}".format(stats.month_sales / 30 if stats.month_sales > 0 else 0) }}</h4>
                        <small class="text-muted">Promedio diario</small>
                    </div>
                    <div class="col-md-6 text-center mb-3">
                        <h4 class="text-success">{{ "{:.1f}".format(stats.total_orders / 7 if stats.total_orders > 0 else 0) }}</h4>
                        <small class="text-muted">Órdenes promedio/día</small>
                    </div>
                    <div class="col-md-6 text-center mb-3">
                        <h4 class="text-warning">${{ "{:,.0f}".format(stats.week_sales / stats.total_orders if stats.total_orders > 0 else 0) }}</h4>
                        <small class="text-muted">Ticket promedio</small>
                    </div>
                    <div class="col-md-6 text-center mb-3">
                        <h4 class="text-info">{{ top_products|length if top_products else 0 }}</h4>
                        <small class="text-muted">Productos vendidos</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mensaje si no hay datos -->
{% if stats.total_orders == 0 %}
<div class="alert alert-info text-center">
    <i class="fas fa-info-circle fa-2x mb-3"></i>
    <h5>No hay datos suficientes para mostrar reportes</h5>
    <p>Los reportes aparecerán una vez que se registren ventas en el sistema.</p>
    <a href="{{ url_for('new_order') }}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Crear Primera Orden
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Función para establecer rangos de fechas rápidos
function setDateRange(range) {
    const today = new Date();
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    let startDate, endDate;
    
    switch(range) {
        case 'today':
            startDate = new Date(today);
            endDate = new Date(today);
            break;
            
        case 'yesterday':
            startDate = new Date(today);
            startDate.setDate(today.getDate() - 1);
            endDate = new Date(startDate);
            break;
            
        case 'week':
            // Esta semana (lunes a domingo)
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            startDate = new Date(today);
            startDate.setDate(diff);
            endDate = new Date(today);
            break;
            
        case 'last_week':
            const lastWeekStart = new Date(today);
            const lastWeekDayOfWeek = today.getDay();
            const lastWeekDiff = today.getDate() - lastWeekDayOfWeek + (lastWeekDayOfWeek === 0 ? -6 : 1) - 7;
            lastWeekStart.setDate(lastWeekDiff);
            startDate = new Date(lastWeekStart);
            endDate = new Date(lastWeekStart);
            endDate.setDate(lastWeekStart.getDate() + 6);
            break;
            
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today);
            break;
            
        case 'last_month':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
            
        case 'quarter':
            const quarter = Math.floor(today.getMonth() / 3);
            startDate = new Date(today.getFullYear(), quarter * 3, 1);
            endDate = new Date(today);
            break;
            
        case 'year':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today);
            break;
    }
    
    // Formatear fechas a YYYY-MM-DD
    if (startDate) {
        startDateInput.value = startDate.toISOString().split('T')[0];
    }
    if (endDate) {
        endDateInput.value = endDate.toISOString().split('T')[0];
    }
    
    // Enviar formulario automáticamente
    document.getElementById('date-filter-form').submit();
}

// Función para exportar a Excel
function exportToExcel() {
    // Obtener parámetros de fecha actuales
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start_date') || '';
    const endDate = urlParams.get('end_date') || '';
    
    // Mostrar modal de carga
    showExportModal();
    
    // Crear URL para exportación
    let exportUrl = '/reports/export/excel';
    const params = new URLSearchParams();
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    if (params.toString()) {
        exportUrl += '?' + params.toString();
    }
    
    // Descargar archivo
    const link = document.createElement('a');
    link.href = exportUrl;
    link.download = `reporte_ventas_${new Date().toISOString().split('T')[0]}.xlsx`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Cerrar modal después de un momento
    setTimeout(() => {
        hideExportModal();
    }, 2000);
}

// Modal de exportación
function showExportModal() {
    // Crear modal si no existe
    if (!document.getElementById('exportModal')) {
        const modalHtml = `
            <div class="modal fade" id="exportModal" tabindex="-1" data-bs-backdrop="static">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                        <div class="modal-body text-center p-4">
                            <div class="spinner-border text-success mb-3" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <h6>Generando Reporte Excel</h6>
                            <p class="text-muted mb-0">Por favor espera...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

function hideExportModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
    if (modal) {
        modal.hide();
    }
}

// Resaltar filtro activo
document.addEventListener('DOMContentLoaded', function() {
    // Establecer fechas por defecto si no hay filtros
    const urlParams = new URLSearchParams(window.location.search);
    if (!urlParams.get('start_date') && !urlParams.get('end_date')) {
        // Por defecto mostrar últimos 7 días
        const today = new Date();
        const lastWeek = new Date(today);
        lastWeek.setDate(today.getDate() - 7);
        
        document.getElementById('start_date').value = lastWeek.toISOString().split('T')[0];
        document.getElementById('end_date').value = today.toISOString().split('T')[0];
    }
    
    // Detectar qué filtro está activo
    const startDate = urlParams.get('start_date');
    const endDate = urlParams.get('end_date');
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const today = new Date();
        
        // Comparar fechas para determinar filtro activo
        const todayStr = today.toISOString().split('T')[0];
        const yesterdayStr = new Date(today.getTime() - 24*60*60*1000).toISOString().split('T')[0];
        
        if (startDate === todayStr && endDate === todayStr) {
            highlightActiveFilter('today');
        } else if (startDate === yesterdayStr && endDate === yesterdayStr) {
            highlightActiveFilter('yesterday');
        }
        // Agregar más comparaciones según sea necesario
    }
});

function highlightActiveFilter(filterType) {
    // Remover clase active de todos
    document.querySelectorAll('.quick-filter').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Agregar clase active al filtro correspondiente
    const filterMap = {
        'today': 'Hoy',
        'yesterday': 'Ayer',
        'week': 'Esta Semana',
        'last_week': 'Semana Pasada',
        'month': 'Este Mes',
        'last_month': 'Mes Pasado',
        'quarter': 'Este Trimestre',
        'year': 'Este Año'
    };
    
    const targetText = filterMap[filterType];
    if (targetText) {
        const targetBtn = Array.from(document.querySelectorAll('.quick-filter'))
            .find(btn => btn.textContent.trim() === targetText);
        if (targetBtn) {
            targetBtn.classList.add('active');
        }
    }
}

// Auto-refresh cada 5 minutos solo si hay datos
{% if stats.total_orders > 0 %}
setInterval(function() {
    location.reload();
}, 300000);
{% endif %}

// Atajos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl+E para exportar
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        exportToExcel();
    }
    
    // Ctrl+F para focus en fecha inicio
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('start_date').focus();
    }
});
</script>
{% endblock %}