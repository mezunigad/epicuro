# ==========================================
# CONFIGURACI√ìN DE PROTE√çNAS SIN COSTO
# ==========================================

import sqlite3
from flask import Flask

def configure_proteins_no_cost():
    """Configurar todas las prote√≠nas para que NO tengan costo adicional"""
    try:
        # Conectar a la base de datos
        db_files = ['database.db', 'app.db', 'instance/database.db', 'sandwich.db']
        db_path = None
        
        for db_file in db_files:
            try:
                conn = sqlite3.connect(db_file)
                conn.execute("SELECT 1 FROM sqlite_master WHERE type='table' AND name='variation_groups'")
                db_path = db_file
                conn.close()
                break
            except:
                continue
        
        if not db_path:
            print("‚ùå No se encontr√≥ base de datos con tablas de variaciones")
            return False
        
        print(f"üìç Usando base de datos: {db_path}")
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # 1. Verificar que existe el grupo de prote√≠nas
        cursor.execute("SELECT id FROM variation_groups WHERE name = 'protein'")
        protein_group = cursor.fetchone()
        
        if not protein_group:
            print("‚ö†Ô∏è  Grupo de prote√≠nas no existe. Cre√°ndolo...")
            cursor.execute("""
                INSERT INTO variation_groups (name, display_name, description) 
                VALUES ('protein', 'Prote√≠na', 'Tipo de prote√≠na (sin costo adicional)')
            """)
            protein_group_id = cursor.lastrowid
        else:
            protein_group_id = protein_group[0]
            print(f"‚úÖ Grupo de prote√≠nas encontrado: ID {protein_group_id}")
        
        # 2. Actualizar todas las prote√≠nas para que tengan price_modifier = 0
        cursor.execute("""
            UPDATE variation_options 
            SET price_modifier = 0 
            WHERE variation_group_id = ?
        """, (protein_group_id,))
        
        affected_rows = cursor.rowcount
        print(f"‚úÖ Actualizadas {affected_rows} opciones de prote√≠na a costo $0")
        
        # 3. Verificar que las prote√≠nas b√°sicas existen
        basic_proteins = [
            ('Churrasco', 'Churrasco a la plancha'),
            ('Lomito', 'Lomito de cerdo'),
            ('Pollo', 'Pechuga de pollo')
        ]
        
        for protein_name, description in basic_proteins:
            cursor.execute("""
                SELECT id FROM variation_options 
                WHERE variation_group_id = ? AND name = ?
            """, (protein_group_id, protein_name))
            
            if not cursor.fetchone():
                print(f"‚ûï Agregando prote√≠na: {protein_name}")
                cursor.execute("""
                    INSERT INTO variation_options 
                    (variation_group_id, name, display_name, price_modifier, active) 
                    VALUES (?, ?, ?, 0, 1)
                """, (protein_group_id, protein_name, protein_name))
            else:
                print(f"‚úÖ Prote√≠na ya existe: {protein_name}")
        
        # 4. Mostrar resumen final
        cursor.execute("""
            SELECT vo.name, vo.price_modifier, vo.active
            FROM variation_options vo
            WHERE vo.variation_group_id = ?
            ORDER BY vo.name
        """, (protein_group_id,))
        
        proteins = cursor.fetchall()
        
        print("\nüçñ RESUMEN DE PROTE√çNAS CONFIGURADAS:")
        print("=" * 45)
        for protein in proteins:
            status = "‚úÖ ACTIVA" if protein[2] else "‚ùå INACTIVA"
            cost = f"${protein[1]}" if protein[1] != 0 else "GRATIS"
            print(f"  {protein[0]:12} | {cost:8} | {status}")
        
        # 5. Verificar configuraci√≥n de productos
        cursor.execute("""
            SELECT COUNT(*) FROM product_variations pv
            JOIN variation_groups vg ON pv.variation_group_id = vg.id
            WHERE vg.name = 'protein'
        """)
        
        products_with_protein = cursor.fetchone()[0]
        print(f"\nüìä Productos con opci√≥n de prote√≠na: {products_with_protein}")
        
        conn.commit()
        conn.close()
        
        print("\nüéâ ¬°CONFIGURACI√ìN COMPLETADA!")
        print("‚úÖ Todas las prote√≠nas est√°n configuradas SIN COSTO ADICIONAL")
        print("‚úÖ Los clientes pueden elegir prote√≠na sin pagar extra")
        print("‚úÖ La selecci√≥n aparecer√° claramente en la comanda de cocina")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error configurando prote√≠nas: {e}")
        return False

def verify_protein_setup():
    """Verificar que la configuraci√≥n de prote√≠nas est√° correcta"""
    try:
        db_files = ['database.db', 'app.db', 'instance/database.db', 'sandwich.db']
        db_path = None
        
        for db_file in db_files:
            try:
                conn = sqlite3.connect(db_file)
                conn.execute("SELECT 1 FROM sqlite_master WHERE type='table' AND name='variation_groups'")
                db_path = db_file
                conn.close()
                break
            except:
                continue
        
        if not db_path:
            print("‚ùå No se encontr√≥ base de datos")
            return False
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # Verificar prote√≠nas
        cursor.execute("""
            SELECT vo.name, vo.price_modifier
            FROM variation_options vo
            JOIN variation_groups vg ON vo.variation_group_id = vg.id
            WHERE vg.name = 'protein' AND vo.active = 1
        """)
        
        proteins = cursor.fetchall()
        
        print("üîç VERIFICACI√ìN DE CONFIGURACI√ìN:")
        print("=" * 40)
        
        all_free = True
        for protein in proteins:
            if protein[1] != 0:
                print(f"‚ùå {protein[0]}: ${protein[1]} (DEBER√çA SER $0)")
                all_free = False
            else:
                print(f"‚úÖ {protein[0]}: GRATIS")
        
        if all_free and proteins:
            print(f"\nüéâ ¬°PERFECTO! Todas las {len(proteins)} prote√≠nas son GRATIS")
        elif not proteins:
            print("\n‚ö†Ô∏è  No hay prote√≠nas configuradas")
        else:
            print(f"\n‚ùå Hay prote√≠nas con costo. Ejecuta configure_proteins_no_cost()")
        
        conn.close()
        return all_free
        
    except Exception as e:
        print(f"‚ùå Error verificando: {e}")
        return False

# ==========================================
# SQL PARA ACTUALIZAR FORMULARIO DE √ìRDENES
# ==========================================

def update_order_form_for_free_proteins():
    """Actualizar el template del formulario para mostrar que las prote√≠nas son gratis"""
    
    # JavaScript para el formulario de √≥rdenes
    js_code = """
// Funci√≥n para actualizar precio cuando se seleccionan variaciones
function updateProductPrice(productId) {
    const selectedVariations = [];
    const checkboxes = document.querySelectorAll(`input[name="variations_${productId}[]"]:checked`);
    
    checkboxes.forEach(checkbox => {
        selectedVariations.push(checkbox.value);
    });
    
    // Las prote√≠nas NO suman costo, solo otros extras
    fetch(`/api/product/${productId}/price`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            variations: selectedVariations
        })
    })
    .then(response => response.json())
    .then(data => {
        const priceElement = document.getElementById(`price_${productId}`);
        if (priceElement) {
            priceElement.textContent = `$${data.final_price}`;
        }
        
        // Mostrar breakdown de precio si hay extras con costo
        const extraCost = data.total_modifier;
        const proteinNote = document.getElementById(`protein_note_${productId}`);
        if (proteinNote) {
            if (extraCost > 0) {
                proteinNote.innerHTML = '<small class="text-success">‚úÖ Prote√≠na: GRATIS | Extras: +$' + extraCost + '</small>';
            } else {
                proteinNote.innerHTML = '<small class="text-success">‚úÖ Prote√≠na: GRATIS</small>';
            }
        }
    });
}

// Agregar evento a todos los checkboxes de variaciones
document.addEventListener('DOMContentLoaded', function() {
    const variationCheckboxes = document.querySelectorAll('input[name^="variations_"]');
    variationCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const productId = this.name.match(/variations_(\d+)/)[1];
            updateProductPrice(productId);
        });
    });
});
"""
    
    print("üìÑ C√ìDIGO JAVASCRIPT PARA EL FORMULARIO:")
    print("=" * 50)
    print(js_code)
    print("\nüí° Agrega este JavaScript a tu template create_order.html")
    
    # CSS para mostrar claramente las prote√≠nas gratis
    css_code = """
.protein-variation {
    background-color: #e8f5e8 !important;
    border: 2px solid #4caf50 !important;
    border-radius: 5px;
    padding: 8px;
}

.protein-variation label {
    font-weight: bold !important;
    color: #2e7d32 !important;
}

.protein-variation::after {
    content: " üÜì GRATIS";
    color: #4caf50;
    font-size: 0.8em;
    font-weight: bold;
}

.variation-group.protein {
    border-left: 4px solid #4caf50;
    padding-left: 10px;
    margin-bottom: 15px;
}

.free-protein-badge {
    background: #4caf50;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: bold;
    margin-left: 5px;
}
"""
    
    print("\nüé® C√ìDIGO CSS PARA DESTACAR PROTE√çNAS GRATIS:")
    print("=" * 50)
    print(css_code)
    
    return js_code, css_code

# ==========================================
# SCRIPT PRINCIPAL
# ==========================================

if __name__ == '__main__':
    print("üçñ CONFIGURADOR DE PROTE√çNAS SIN COSTO")
    print("=" * 50)
    
    # 1. Configurar prote√≠nas sin costo
    print("\n1Ô∏è‚É£ Configurando prote√≠nas...")
    configure_proteins_no_cost()
    
    # 2. Verificar configuraci√≥n
    print("\n2Ô∏è‚É£ Verificando configuraci√≥n...")
    verify_protein_setup()
    
    # 3. Generar c√≥digo para formularios
    print("\n3Ô∏è‚É£ Generando c√≥digo para formularios...")
    update_order_form_for_free_proteins()
    
    print("\n" + "=" * 50)
    print("üéØ PR√ìXIMOS PASOS:")
    print("=" * 50)
    print("1. ‚úÖ Ejecuta este script: python protein_setup.py")
    print("2. üìù Actualiza tu formulario create_order.html con el CSS/JS generado")
    print("3. üñ®Ô∏è Usa el template kitchen_print.html para las comandas")
    print("4. üß™ Prueba creando una orden con prote√≠na")
    print("5. ‚úÖ Verifica que la prote√≠na aparece en la comanda SIN COSTO")
    
    print("\nüéâ ¬°LISTO! Las prote√≠nas ya est√°n configuradas sin costo adicional")
